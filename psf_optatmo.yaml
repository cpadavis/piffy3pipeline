# Copyright (c) 2016 by Mike Jarvis and the other collaborators on GitHub at
# https://github.com/rmjarvis/Piff  All rights reserved.
#
# Piff is free software: Redistribution and use in source and binary forms
# with or without modification, are permitted provided that the following
# conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the disclaimer given in the accompanying LICENSE
#    file.
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the disclaimer given in the documentation
#    and/or other materials provided with the distribution.

modules:
    - galsim_extra

input:

    cat_file_name:
        type: Eval
        str: image_file_name.replace("psf_im", "psf_cat").replace(".fits.fz", ".fits")
        simage_file_name: '@input.image_file_name'

    chipnum:
        type: Eval
        str: image_file_name.split('_')[-1].split('.fits')[0]
        simage_file_name: '@input.image_file_name'

    # What hdu is everything in?
    image_hdu: 1
    badpix_hdu: 2
    weight_hdu: 3
    cat_hdu: 1

    # What columns in the catalog have things we need?
    x_col: x
    y_col: y
    ra: ra
    dec: dec
    gain: 1.0
    sky_col: sky

    # How large should the postage stamp cutouts of the stars be?
    stamp_size: 19

    # stick to well measured stars here
    min_snr: 20

    # practically remove max_snr limit
    max_snr: 100

    # settings for cuts on stars with deformed postage stamp shapes from the edges of the focal plane, stars with nuisance stars, and stars that are partially masked
    _cutoff_deformed_level : 1
    _cutoff_nuisance_level : 7.5
    _cutoff_masked_level : 1

psf:
    type: OptAtmo
    optical_psf_kwargs:
        template: des_vonkarman
    optatmo_psf_kwargs:
        fix_zPupil004_zFocal001: False  
        fix_zPupil004_zFocal002: True  
        fix_zPupil004_zFocal003: True  
        fix_zPupil005_zFocal001: False  
        fix_zPupil005_zFocal002: False  
        fix_zPupil005_zFocal003: False
        fix_zPupil006_zFocal001: False  
        fix_zPupil006_zFocal002: False  
        fix_zPupil006_zFocal003: False  
        fix_zPupil007_zFocal001: False  
        fix_zPupil007_zFocal002: False  
        fix_zPupil007_zFocal003: False  
        fix_zPupil008_zFocal001: False  
        fix_zPupil008_zFocal002: False  
        fix_zPupil008_zFocal003: False  
        fix_zPupil009_zFocal001: False  
        fix_zPupil009_zFocal002: True  
        fix_zPupil009_zFocal003: True  
        fix_zPupil010_zFocal001: False  
        fix_zPupil010_zFocal002: True  
        fix_zPupil010_zFocal003: True  
        fix_zPupil011_zFocal001: False  
        fix_zPupil011_zFocal002: True  
        fix_zPupil011_zFocal003: True  
        fix_zPupil012_zFocal001: True  
        fix_zPupil012_zFocal002: True  
        fix_zPupil012_zFocal003: True  
        fix_zPupil013_zFocal001: True  
        fix_zPupil013_zFocal002: True  
        fix_zPupil013_zFocal003: True  
        fix_zPupil014_zFocal001: False  
        fix_zPupil014_zFocal002: True  
        fix_zPupil014_zFocal003: True  
        fix_zPupil015_zFocal001: False  
        fix_zPupil015_zFocal002: True  
        fix_zPupil015_zFocal003: True 
        fix_zPupil016_zFocal001: True  
        fix_zPupil016_zFocal002: True  
        fix_zPupil016_zFocal003: True
        fix_zPupil017_zFocal001: True  
        fix_zPupil017_zFocal002: True  
        fix_zPupil017_zFocal003: True
        fix_zPupil018_zFocal001: True  
        fix_zPupil018_zFocal002: True  
        fix_zPupil018_zFocal003: True
        fix_zPupil019_zFocal001: True  
        fix_zPupil019_zFocal002: True  
        fix_zPupil019_zFocal003: True
        fix_zPupil020_zFocal001: True  
        fix_zPupil020_zFocal002: True  
        fix_zPupil020_zFocal003: True
        fix_zPupil021_zFocal001: True  
        fix_zPupil021_zFocal002: True  
        fix_zPupil021_zFocal003: True
        fix_zPupil022_zFocal001: True
        fix_zPupil022_zFocal002: True  
        fix_zPupil022_zFocal003: True
        fix_zPupil023_zFocal001: True  
        fix_zPupil023_zFocal002: True  
        fix_zPupil023_zFocal003: True
        fix_zPupil024_zFocal001: True  
        fix_zPupil024_zFocal002: True  
        fix_zPupil024_zFocal003: True
        fix_zPupil025_zFocal001: True  
        fix_zPupil025_zFocal002: True  
        fix_zPupil025_zFocal003: True
        fix_zPupil026_zFocal001: True  
        fix_zPupil026_zFocal002: True  
        fix_zPupil026_zFocal003: True
        fix_zPupil027_zFocal001: True  
        fix_zPupil027_zFocal002: True  
        fix_zPupil027_zFocal003: True
        fix_zPupil028_zFocal001: True  
        fix_zPupil028_zFocal002: True  
        fix_zPupil028_zFocal003: True
        fix_zPupil029_zFocal001: True  
        fix_zPupil029_zFocal002: True  
        fix_zPupil029_zFocal003: True
        fix_zPupil030_zFocal001: True  
        fix_zPupil030_zFocal002: True  
        fix_zPupil030_zFocal003: True
        fix_zPupil031_zFocal001: True  
        fix_zPupil031_zFocal002: True  
        fix_zPupil031_zFocal003: True
        fix_zPupil032_zFocal001: True  
        fix_zPupil032_zFocal002: True  
        fix_zPupil032_zFocal003: True
        fix_zPupil033_zFocal001: True  
        fix_zPupil033_zFocal002: True  
        fix_zPupil033_zFocal003: True
        fix_zPupil034_zFocal001: True  
        fix_zPupil034_zFocal002: True  
        fix_zPupil034_zFocal003: True
        fix_zPupil035_zFocal001: True  
        fix_zPupil035_zFocal002: True  
        fix_zPupil035_zFocal003: True
        fix_zPupil036_zFocal001: True  
        fix_zPupil036_zFocal002: True  
        fix_zPupil036_zFocal003: True
        fix_zPupil037_zFocal001: True
        fix_zPupil037_zFocal002: True  
        fix_zPupil037_zFocal003: True


    max_shapes: [1.5, 0.12, 0.12, 0.15, 0.15, 0.15, 0.15, 1.5, 5.0, 50.0]
    shape_weights: [0.2, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4]
    reference_wavefront_zernikes_list: [4, 5, 6, 7, 8, 9, 10, 11]
    higher_order_reference_wavefront_zernikes_list: [12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37]
    reference_wavefront:
        type: DECamWavefront
        file_name: /nfs/slac/kipac/fs1/g/des/aresh/lower_order_reference_wavefront_folder/Science-20140212s2-v22i2.fits
        extname: 1
        n_neighbors: 10
        weights: distance
        algorithm: auto
        p: 2
    atmo_interp: none
    n_optfit_stars: 0
    fov_radius: 4500.
    jmax_pupil: 37
    jmax_focal: 3
    min_optfit_snr: 40
    fit_optics_mode: shape
    higher_order_reference_wavefront_file: /nfs/slac/kipac/fs1/g/des/aresh/higher_order_reference_wavefront_pickle/decam_2012-nominalzernike-protocol2.pickle
    random_forest_shapes_model_pickles_location: /nfs/slac/kipac/fs1/g/des/aresh/random_forest_shapes_model_pickles
    atmosphere_model: vonkarman


output:

    # The output directory is by default the same as the input, but can specify a different one.
    file_name: psf_optatmo.piff

    stats:

        # Multiple output statistics can be listed in a list
        -
            type: ShapeHistograms
            file_name: shapes_optatmo.pdf
            bins_size: 100
            bins_shape: 100
        -
            type: Rho
            file_name: rho_optatmo.pdf
            # Rho can use any config parameters used by TreeCorr for doing the correlation.
            min_sep: 0.1
            max_sep: 300
            sep_units: arcmin
            bin_size: 0.2
        -
            type: TwoDHist
            file_name: twodhist_optatmo.pdf
            number_bins_u: 30
            number_bins_v: 30
        -
            type: Star
            file_name: stars_optatmo.pdf
            adjust_stars: False
            number_plot: 10

# Set the verbosity level a little higher than default (1) to give extra information
# about the progress.
verbose: 2

time: 7000
memory: 6
test_fraction: 0.2 # save 20 percent

interps:
    const_gpvonkarman:
        type: GPInterp2pcf
        kernel: 1e-6 + 1e-2 * VonKarman(1e2, (1e-8, 1e5))
